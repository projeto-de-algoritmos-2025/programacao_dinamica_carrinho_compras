<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carrinho de Compras - Programação Dinâmica</title>

    <!-- DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" />

    <!-- Tailwind -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
  /* Fundo adaptável usando as variáveis do DaisyUI */
  body {
    background: var(--fallback-b1, var(--b1)) !important; /* Base dinâmica do tema */
    background-image:
      repeating-linear-gradient(
        45deg,
        rgba(0, 0, 0, 0.04) 0px,
        rgba(0, 0, 0, 0.04) 2px,
        transparent 2px,
        transparent 6px
      );
    background-attachment: fixed;
  }

  /* Ajuste automático para temas escuros */
  html[data-theme="dark"] body,
  :root[data-theme="dark"] body,
  [data-theme="dark"] body {
    background-image:
      repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.06) 0px,
        rgba(255, 255, 255, 0.06) 2px,
        transparent 2px,
        transparent 6px
      );
  }
</style>

</head>

<body class="p-6 space-y-8 bg-base-100">
    <div class="container mx-auto max-w-3xl">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold">Carrinho de Compras Inteligente</h1>
                <p class="subtitle opacity-70">Otimize suas compras com seu orçamento disponível</p>
            </div>

            <!-- THEME CONTROLLER -->
            <label class="flex cursor-pointer gap-2 items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5" />
                    <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" />
                </svg>

                <input type="checkbox" value="synthwave" class="toggle theme-controller" />

                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z" />
                </svg>
            </label>
        </header>

        <main class="space-y-10">

            <!-- ETAPA 1 -->
            <section class="card bg-base-200 shadow-md">
                <div class="card-body">
                    <span class="badge badge-primary badge-sm mb-2">Etapa 1</span>
                    <h2 class="card-title text-2xl font-semibold">Seu Orçamento</h2>

                    <div class="flex flex-col gap-4 mt-4">
                        <label for="budget" class="font-medium">Dinheiro disponível (R$):</label>
                        <input type="number" id="budget" min="0" step="0.01"
                               placeholder="Ex: 500.00" class="input input-bordered w-full" />

                        <!-- AQUI ESTAVA O ERRO: botão sem id -->
                        <button id="setBudget" class="btn btn-success w-full">Definir orçamento</button>
                    </div>

                    <div id="budgetDisplay" class="alert alert-success mt-4 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current"
                             fill="none" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                   d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Orçamento atual: <strong id="currentBudget">R$ 0,00</strong></span>
                    </div>
                </div>
            </section>

            <!-- ETAPA 2 -->
            <section class="card bg-base-200 shadow-md">
                <div class="card-body">
                    <span class="badge badge-primary badge-sm mb-2">Etapa 2</span>
                    <h2 class="card-title text-2xl font-semibold">Adicionar Item ao Carrinho</h2>

                    <form id="itemForm" class="space-y-4 mt-4">
                        <div class="flex flex-col gap-2">
                            <label for="itemName">Nome do Item:</label>
                            <input type="text" id="itemName" required placeholder="Ex: Notebook" class="input input-bordered w-full" />
                        </div>

                        <div class="flex flex-col gap-2">
                            <label for="itemPrice">Preço (R$):</label>
                            <input type="number" id="itemPrice" min="0.01" step="0.01" required placeholder="Ex: 299.90" class="input input-bordered w-full" />
                        </div>

                        <div class="flex flex-col gap-2">
                            <label for="itemPriority">Prioridade (1-10):</label>
                            <input type="number" id="itemPriority" min="1" max="10" required placeholder="Ex: 8" class="input input-bordered w-full" />
                        </div>

                        <button type="submit" class="btn btn-success w-full">Adicionar Item</button>
                    </form>
                </div>
            </section>

            <!-- ETAPA 3 -->
            <section class="card bg-base-200 shadow-md">
                <div class="card-body">
                    <span class="badge badge-primary badge-sm mb-2">Etapa 3</span>
                    <h2 class="card-title text-2xl font-semibold">Seus Itens</h2>

                    <div id="emptyCart" class="alert alert-warning mt-4">
                        Nenhum item adicionado ainda. Adicione itens acima!
                    </div>

                    <div id="cartItems" class="hidden flex flex-col gap-4 mt-4"></div>
                </div>
            </section>

            <!-- ETAPA 4 -->
            <section class="card bg-base-200 shadow-md hidden" id="optimizationSection">
                <div class="card-body">
                    <span class="badge badge-primary badge-sm mb-2">Etapa 4</span>
                    <h2 class="card-title text-2xl font-semibold">Itens Recomendados (Otimização)</h2>

                    <button id="optimizeBtn" class="btn btn-accent mt-4">Otimizar Seleção</button>

                    <div id="optimizedResult" class="hidden mt-6">
                        <h3 class="text-xl font-semibold mb-4">Resultado da Otimização:</h3>

                        <div id="optimizedItems" class="space-y-3"></div>

                        <div class="p-4 rounded-xl bg-base-100 shadow mt-4">
                            <p>Total: <strong id="optimizedTotal">R$ 0,00</strong></p>
                            <p>Valor total de prioridade: <strong id="optimizedPriority">0</strong></p>
                            <p>Restante do orçamento: <strong id="remainingBudget">R$ 0,00</strong></p>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <footer class="text-center mt-10 opacity-70">
            Usando Programação Dinâmica (Problema da Mochila)
        </footer>

    </div>

    <!-- JS: TEMA DA DAISYUI + LOCALSTORAGE -->

    <script>
    (function(){
      const STORAGE_KEY = "daisyui-theme";
      const controllers = [...document.querySelectorAll("input")].filter(el =>
          (el.className || "").includes("theme-controller")
      );

      function applyTheme(theme){
        if(theme){
          document.documentElement.setAttribute("data-theme", theme);
        } else {
          document.documentElement.removeAttribute("data-theme");
        }
      }

      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved){
        applyTheme(saved);
        controllers.forEach(c => c.checked = (c.value === saved));
      }

      controllers.forEach(ctrl => {
        ctrl.addEventListener("change", () => {
          if(ctrl.checked){
            applyTheme(ctrl.value);
            localStorage.setItem(STORAGE_KEY, ctrl.value);
            controllers.forEach(c => { if(c !== ctrl) c.checked = false; });
          } else {
            applyTheme(null);
            localStorage.removeItem(STORAGE_KEY);
          }
        });
      });
    })();
    </script>


    <!-- JS PRINCIPAL DO CARRINHO + API FASTAPI -->
    <script>

    const API_URL = 'http://localhost:8000';

    let budget = 0;
    let items = [];

    const budgetInput = document.getElementById('budget');
    const setBudgetBtn = document.getElementById('setBudget');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const currentBudgetSpan = document.getElementById('currentBudget');
    const itemForm = document.getElementById('itemForm');
    const itemNameInput = document.getElementById('itemName');
    const itemPriceInput = document.getElementById('itemPrice');
    const itemPriorityInput = document.getElementById('itemPriority');
    const emptyCart = document.getElementById('emptyCart');
    const cartItems = document.getElementById('cartItems');
    const optimizationSection = document.getElementById('optimizationSection');
    const optimizeBtn = document.getElementById('optimizeBtn');
    const optimizedResult = document.getElementById('optimizedResult');
    const optimizedItems = document.getElementById('optimizedItems');
    const optimizedTotal = document.getElementById('optimizedTotal');
    const optimizedPriority = document.getElementById('optimizedPriority');
    const remainingBudget = document.getElementById('remainingBudget');

    setBudgetBtn.addEventListener('click', setBudget);
    itemForm.addEventListener('submit', addItem);
    optimizeBtn.addEventListener('click', optimizeCart);
    window.addEventListener('DOMContentLoaded', loadCartStatus);

    async function loadCartStatus() {
        try {
            const response = await fetch(`${API_URL}/cart/status`);
            if (response.ok) {
                const data = await response.json();
                budget = data.budget;
                items = data.items || [];
                
                if (budget > 0) {
                    currentBudgetSpan.textContent = formatCurrency(budget);
                    budgetDisplay.classList.remove('hidden');
                }
                
                renderCart();
                
                if (budget > 0 && items.length > 0) {
                    optimizationSection.classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('Erro ao carregar status do carrinho:', error);
            showError('Não foi possível conectar à API. Certifique-se de que o servidor FastAPI está rodando.');
        }
    }

    async function setBudget() {
        const value = parseFloat(budgetInput.value);
        
        if (isNaN(value) || value <= 0) {
            alert('Por favor, insira um valor válido para o orçamento.');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/budget`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ budget: value })
            });
            
            if (response.ok) {
                const data = await response.json();
                budget = data.budget;
                currentBudgetSpan.textContent = formatCurrency(budget);
                budgetDisplay.classList.remove('hidden');
                budgetInput.value = '';
                
                if (items.length > 0) {
                    optimizationSection.classList.remove('hidden');
                }
            } else {
                throw new Error('Erro ao definir orçamento');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao definir orçamento. Verifique se a API está rodando.');
        }
    }

    async function addItem(e) {
        e.preventDefault();
        
        const name = itemNameInput.value.trim();
        const price = parseFloat(itemPriceInput.value);
        const priority = parseInt(itemPriorityInput.value);
        
        if (!name || isNaN(price) || price <= 0 || isNaN(priority) || priority < 1 || priority > 10) {
            alert('Por favor, preencha todos os campos corretamente.');
            return;
        }
        
        const item = { name, price, priority };
        
        try {
            const response = await fetch(`${API_URL}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            });
            
            if (response.ok) {
                const data = await response.json();
                items.push(data.item);
                
                itemForm.reset();
                renderCart();
                
                if (budget > 0) {
                    optimizationSection.classList.remove('hidden');
                }
            } else {
                throw new Error('Erro ao adicionar item');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao adicionar item. Verifique se a API está rodando.');
        }
    }

    async function deleteItem(id) {
        if (confirm('Tem certeza que deseja remover este item?')) {
            try {
                const response = await fetch(`${API_URL}/items/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    items = items.filter(item => item.id !== id);
                    renderCart();
                    
                    if (items.length === 0) {
                        optimizationSection.classList.add('hidden');
                        optimizedResult.classList.add('hidden');
                    }
                } else {
                    throw new Error('Erro ao deletar item');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao deletar item. Verifique se a API está rodando.');
            }
        }
    }

    function renderCart() {
        if (items.length === 0) {
            emptyCart.classList.remove('hidden');
            cartItems.classList.add('hidden');
            cartItems.innerHTML = '';
            return;
        }
        
        emptyCart.classList.add('hidden');
        cartItems.classList.remove('hidden');
        
        cartItems.innerHTML = items.map(item => `
            <div class="cart-item flex justify-between items-center p-4 rounded-xl bg-base-100 shadow">
                <div>
                    <div class="font-bold">${escapeHtml(item.name)}</div>
                    <div class="text-sm opacity-70">Preço: ${formatCurrency(item.price)}</div>
                    <div class="text-sm opacity-70">Prioridade: ${item.priority}/10</div>
                </div>
                <button class="btn btn-error btn-sm" onclick="deleteItem(${item.id})">Deletar</button>
            </div>
        `).join('');
    }

    async function optimizeCart() {
        if (items.length === 0) {
            alert('Adicione itens ao carrinho primeiro.');
            return;
        }
        
        if (budget <= 0) {
            alert('Defina um orçamento primeiro.');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/optimize/current`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                renderOptimizedResult(
                    data.selected_items,
                    data.total_price,
                    data.total_priority,
                    data.remaining_budget
                );
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao otimizar carrinho');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao otimizar carrinho: ' + error.message);
        }
    }

    function renderOptimizedResult(selectedItems, totalPrice, totalPriority, remaining) {
        optimizedResult.classList.remove('hidden');
        
        if (selectedItems.length === 0) {
            optimizedItems.innerHTML = '<p class="text-center opacity-70 p-4">Nenhum item pode ser selecionado com o orçamento disponível.</p>';
            optimizedTotal.textContent = formatCurrency(0);
            optimizedPriority.textContent = '0';
            remainingBudget.textContent = formatCurrency(budget);
            return;
        }
        
        optimizedItems.innerHTML = selectedItems.map(item => `
            <div class="flex justify-between p-3 bg-base-100 rounded-xl shadow">
                <span>${escapeHtml(item.name)}</span>
                <span>${formatCurrency(item.price)} — ${item.priority}/10</span>
            </div>
        `).join('');
        
        optimizedTotal.textContent = formatCurrency(totalPrice);
        optimizedPriority.textContent = totalPriority;
        remainingBudget.textContent = formatCurrency(remaining);
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function showError(message) {
        const div = document.createElement('div');
        div.style.cssText = "position: fixed; top:20px; right:20px; background:#dc3545; color:white; padding:15px 20px; border-radius:8px; z-index:1000; box-shadow:0 5px 15px rgba(0,0,0,0.3);";
        div.textContent = message;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 5000);
    }
    </script>
</body>
</html>
